# -*- coding: utf-8 -*-
"""
/***************************************************************************
 GeophysicsMapping
                                 A QGIS plugin
 This plug-in automates the map making workflow
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2025-08-22
        git sha              : $Format:%H$
        copyright            : (C) 2025 by Igor Macedo
        email                : imacedo@axiomex.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""
import os
import re

from qgis.PyQt.QtCore import QSettings, QTranslator, QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.PyQt.QtWidgets import QAction
from qgis.gui import QgsFileWidget
from qgis.PyQt import uic
from qgis.core import (
    QgsProject,
    QgsRasterLayer,
    QgsMapLayerType,
    QgsReadWriteContext,
)

from .layout_editor import LayoutEditor


class GeophysicsMapping:
    def __init__(self, iface):
        self.iface = iface
        self.plugin_dir = os.path.dirname(__file__)
        self.layout_editor = LayoutEditor()
        locale = QSettings().value("locale/userLocale")[0:2]
        locale_path = os.path.join(
            self.plugin_dir, "i18n", f"GeophysicsMapping_{locale}.qm"
        )

        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            QCoreApplication.installTranslator(self.translator)

        self.actions = []
        self.menu = self.tr("&Geophysics Mapping")
        self.first_start = None
        self.current_layout = None
        # Active template path (persisted layout)
        self.active_template_path = os.path.join(
            self.plugin_dir, "templates", "Geophysics_SurveyMaps_Active.qpt"
        )

    def tr(self, message):
        return QCoreApplication.translate("GeophysicsMapping", message)

    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None,
    ):
        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip:
            action.setStatusTip(status_tip)
        if whats_this:
            action.setWhatsThis(whats_this)

        if add_to_toolbar:
            self.iface.addToolBarIcon(action)
        if add_to_menu:
            self.iface.addPluginToMenu(self.menu, action)

        self.actions.append(action)
        return action

    def initGui(self):
        icon_path = os.path.join(
            self.plugin_dir, "icon.png"
        )  # can't have absolute path, use self.plugin_dir instead
        self.add_action(
            icon_path,
            text=self.tr("Geophysics Mapping"),
            callback=self.run,
            parent=self.iface.mainWindow(),
        )
        self.first_start = True

    def unload(self):
        for action in self.actions:
            self.iface.removePluginMenu(self.menu, action)
            self.iface.removeToolBarIcon(action)

    def run(self):
        if self.first_start:
            self.first_start = False
            ui_path = os.path.join(self.plugin_dir, "geophysics_mapping_dialog_base.ui")
            self.dlg = uic.loadUi(ui_path)

            # Configure file pickers
            self.dlg.TemplatemQgsFileWidget.setDialogTitle("Select Geophysics Template")
            self.dlg.TemplatemQgsFileWidget.setFilter("QGIS Layout Template (*.qpt)")

            default_template = os.path.join(
                self.plugin_dir, "templates", "Geophysics_SurveyMaps.qpt"
            )
            self.dlg.TemplatemQgsFileWidget.setFilePath(default_template)

            self.dlg.GeotiffQgsFileWidget.setDialogTitle("Select GeoTIFF Raster File")
            self.dlg.GeotiffQgsFileWidget.setFilter("GeoTIFF (*.tif *.tiff)")
            default_geotiff = os.path.join(self.plugin_dir, "default_geotiff.tif")
            self.dlg.GeotiffQgsFileWidget.setFilePath(default_geotiff)

            self.dlg.LegendQgsFileWidget.setDialogTitle("Select Legend Image or File")
            self.dlg.LegendQgsFileWidget.setFilter(
                "Image Files (*.png *.jpg *.jpeg *.svg);;PDF Files (*.pdf)"
            )
            default_legend = os.path.join(self.plugin_dir, "default_legend.png")
            self.dlg.LegendQgsFileWidget.setFilePath(default_legend)

            # Connect Create button
            self.dlg.CreatePushButton.clicked.connect(self.create_layout_from_template)

        self.dlg.show()

    def get_or_load_raster_layer(self, raster_path):
        for layer in QgsProject.instance().mapLayers().values():
            if (
                layer.type() == QgsMapLayerType.RasterLayer
                and layer.source() == raster_path
            ):
                return layer

        raster_layer = QgsRasterLayer(raster_path, os.path.basename(raster_path))
        if raster_layer.isValid():
            QgsProject.instance().addMapLayer(raster_layer)
            return raster_layer
        return None

    def create_layout_from_template(self):
        try:
            print("Create button clicked - starting layout generation")

            # UI inputs
            template_path = self.dlg.TemplatemQgsFileWidget.filePath()
            raster_path = self.dlg.GeotiffQgsFileWidget.filePath()
            layout_name_text = self.dlg.MapLayoutTextEdit.toPlainText().strip()
            client_location_text = self.dlg.ClientLocationLayoutTextEdit.toPlainText()

            # Use user-entered Client-Location text (preserve newlines)
            self.layout_editor.set_client_location(client_location_text)

            # sanitize layout name
            layout_name = "Geophysics_Map"
            if layout_name_text:
                layout_name = re.sub(r'[\\/:*?"<>|]', "", layout_name_text)

            # Save the currently active layout to the 'Active' template BEFORE creating the new one,
            # but only if there is a current_layout (i.e., this is not the first creation in this session).
            if self.current_layout is not None:
                project = QgsProject.instance()
                layout_manager = project.layoutManager()
                # ensure the layout still exists in the project (it should)
                existing = layout_manager.layoutByName(self.current_layout.name())
                if existing:
                    # overwrite the active template
                    existing.saveAsTemplate(
                        self.active_template_path, QgsReadWriteContext()
                    )
                    print(f"Saved active layout template: {self.active_template_path}")

            # Determine which template to use:
            # - If active template exists, use it (persistence)
            # - Otherwise use the template selected in the UI (first run)
            if os.path.exists(self.active_template_path):
                use_template = self.active_template_path
            else:
                use_template = template_path

            # Create a new layout from the chosen template (so every map opens in a new layout)
            layout = self.layout_editor.create_layout(use_template, layout_name)
            if not layout:
                print("Layout could not be created.")
                return

            # Process raster and apply the correct QML style
            if os.path.exists(raster_path):
                raster_layer = self.get_or_load_raster_layer(raster_path)
                if raster_layer:
                    # FlightPath detection
                    if "flightpath" in os.path.basename(raster_path).lower():
                        qml_file = os.path.join(
                            self.plugin_dir, "templates", "flightpath_style.qml"
                        )
                    else:
                        qml_file = os.path.join(
                            self.plugin_dir, "templates", "transparency_style.qml"
                        )

                    # Apply style
                    self.layout_editor.apply_style_qml(raster_layer, qml_file)

                    # Hide other layers (leave exceptions)
                    self.layout_editor.hide_other_layers(raster_layer)

                    # Zoom to raster extent only for the first map of the session (current_layout is None)
                    zoom_flag = self.current_layout is None
                    # Update map item (and optional zoom)
                    self.layout_editor.update_map_item(
                        layout, raster_layer, zoom_to_extent=zoom_flag
                    )

                    # Update other text/picture items
                    title_text, map_desc, units_text, legend_file = (
                        self.layout_editor.get_map_info(raster_path)
                    )
                    self.layout_editor.update_text_item(layout, "Title", title_text)
                    self.layout_editor.update_text_item(
                        layout, "Client-Location", self.layout_editor.client_location
                    )
                    self.layout_editor.update_text_item(
                        layout, "Map Description", map_desc
                    )
                    self.layout_editor.update_text_item(
                        layout, "Legend Unit", units_text
                    )

                    # Legend handling
                    legend_path = None
                    if legend_file:
                        raster_dir = os.path.dirname(raster_path)
                        legends_folder = os.path.join(raster_dir, "LEGENDS")
                        candidate_path = os.path.join(legends_folder, legend_file)
                        if os.path.exists(candidate_path):
                            legend_path = candidate_path

                    # fallback to manually selected legend
                    if not legend_path or not os.path.exists(legend_path):
                        legend_path = self.dlg.LegendQgsFileWidget.filePath()

                    if os.path.exists(legend_path):
                        self.layout_editor.update_picture_item(
                            layout, "Legend (Oasis)", legend_path
                        )

            # Set the newly created layout as current_layout and open it in a designer window
            self.current_layout = layout
            self.iface.openLayoutDesigner(layout)
            print(f"Layout '{layout_name}' created and opened successfully")

        except Exception as e:
            import traceback

            print("Error creating layout:", e)
            print(traceback.format_exc())
