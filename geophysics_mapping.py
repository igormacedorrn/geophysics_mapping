# -*- coding: utf-8 -*-
"""
/***************************************************************************
 GeophysicsMapping
                                 A QGIS plugin
 This plug-in automates the map making workflow
 Generated by Plugin Builder: http://g-sherman.github.io/Qgis-Plugin-Builder/
                              -------------------
        begin                : 2025-08-22
        git sha              : $Format:%H$
        copyright            : (C) 2025 by Igor Macedo
        email                : imacedo@axiomex.com
 ***************************************************************************/

/***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
"""
import os
import re
import traceback

from qgis.PyQt.QtCore import QSettings, QTranslator, QCoreApplication, QTimer
from qgis.PyQt.QtGui import QIcon
from qgis.PyQt.QtWidgets import QAction
from qgis.PyQt import uic
from qgis.core import (
    QgsProject,
    QgsRasterLayer,
    QgsMapLayerType,
    QgsReadWriteContext,
)

from .layout_editor import LayoutEditor


class GeophysicsMapping:
    """
    Main class for the Geophysics Mapping QGIS plugin.

    Handles UI interactions, template selection, raster loading, and
    maintaining visible layer exceptions across map generations.
    """

    def __init__(self, iface):
        """Initialize the plugin and load translations if available."""
        self.iface = iface
        self.plugin_dir = os.path.dirname(__file__)
        self.layout_editor = LayoutEditor()

        # Load translations
        locale = QSettings().value("locale/userLocale")[0:2]
        locale_path = os.path.join(
            self.plugin_dir, "i18n", f"GeophysicsMapping_{locale}.qm"
        )
        if os.path.exists(locale_path):
            self.translator = QTranslator()
            self.translator.load(locale_path)
            QCoreApplication.installTranslator(self.translator)

        # Plugin state
        self.actions = []
        self.menu = self.tr("&Geophysics Mapping")
        self.first_start = None
        self.current_layout = None

        # Template paths
        self.default_template_path = os.path.join(
            self.plugin_dir, "templates", "Geophysics_SurveyMaps.qpt"
        )
        self.active_template_path = os.path.join(
            self.plugin_dir, "templates", "Geophysics_SurveyMaps_Active.qpt"
        )

        # Settings and session exceptions
        self.settings = QSettings("GNR_Division", "GeophysicsMapping")
        self.session_exceptions = set()  # persists only during QGIS session

    def tr(self, message):
        """Translate string using QGIS translation system."""
        return QCoreApplication.translate("GeophysicsMapping", message)

    # -------------------------------------------------------------------------
    # GUI Actions
    # -------------------------------------------------------------------------

    def add_action(
        self,
        icon_path,
        text,
        callback,
        enabled_flag=True,
        add_to_menu=True,
        add_to_toolbar=True,
        status_tip=None,
        whats_this=None,
        parent=None,
    ):
        """
        Add a toolbar and menu action.

        Returns the QAction object created.
        """
        icon = QIcon(icon_path)
        action = QAction(icon, text, parent)
        action.triggered.connect(callback)
        action.setEnabled(enabled_flag)

        if status_tip:
            action.setStatusTip(status_tip)
        if whats_this:
            action.setWhatsThis(whats_this)

        if add_to_toolbar:
            self.iface.addToolBarIcon(action)
        if add_to_menu:
            self.iface.addPluginToMenu(self.menu, action)

        self.actions.append(action)
        return action

    def initGui(self):
        """Initialize the plugin GUI and connect signals."""
        icon_path = os.path.join(self.plugin_dir, "icon.png")
        self.add_action(
            icon_path,
            text=self.tr("Geophysics Mapping"),
            callback=self.run,
            parent=self.iface.mainWindow(),
        )
        self.first_start = True

        # Connect project signals to update layer list dynamically
        QgsProject.instance().layersAdded.connect(self.update_layers_list)
        QgsProject.instance().layerWillBeRemoved.connect(self.update_layers_list)

    def unload(self):
        """Remove plugin menu items and toolbar icons."""
        for action in self.actions:
            self.iface.removePluginMenu(self.menu, action)
            self.iface.removeToolBarIcon(action)

    # -------------------------------------------------------------------------
    # Plugin Main Window
    # -------------------------------------------------------------------------

    def run(self):
        """Display the main plugin dialog and initialize widgets on first start."""
        if self.first_start:
            self.first_start = False
            ui_path = os.path.join(self.plugin_dir, "geophysics_mapping_dialog_base.ui")
            self.dlg = uic.loadUi(ui_path)

            # Configure file pickers
            self.dlg.TemplatemQgsFileWidget.setDialogTitle("Select Geophysics Template")
            self.dlg.TemplatemQgsFileWidget.setFilter("QGIS Layout Template (*.qpt)")
            self.dlg.TemplatemQgsFileWidget.setFilePath(self.default_template_path)

            self.dlg.GeotiffQgsFileWidget.setDialogTitle("Select GeoTIFF Raster File")
            self.dlg.GeotiffQgsFileWidget.setFilter("GeoTIFF (*.tif *.tiff)")
            self.dlg.GeotiffQgsFileWidget.setFilePath(
                os.path.join(self.plugin_dir, "default_geotiff.tif")
            )

            self.dlg.LegendQgsFileWidget.setDialogTitle("Select Legend Image or File")
            self.dlg.LegendQgsFileWidget.setFilter(
                "Image Files (*.png *.jpg *.jpeg *.svg);;PDF Files (*.pdf)"
            )
            self.dlg.LegendQgsFileWidget.setFilePath(
                os.path.join(self.plugin_dir, "default_legend.png")
            )

            # Connect Create button
            self.dlg.CreatePushButton.clicked.connect(self.create_layout_from_template)

            # Connect MultiSelection layer list
            self.dlg.layerslistWidget.itemSelectionChanged.connect(
                self.update_selected_exceptions
            )

            self.last_selected_layer = self.settings.value("last_selected_layer", "")

        self.dlg.show()
        QTimer.singleShot(100, self.update_layers_list)

    # -------------------------------------------------------------------------
    # Layer List & Exceptions Handling
    # -------------------------------------------------------------------------

    def update_layers_list(self):
        """
        Populate layerslistWidget with project layers and restore session selections.

        Captures current selections before rebuilding the list to avoid losing
        user choices.
        """
        if not hasattr(self, "dlg") or not hasattr(self.dlg, "layerslistWidget"):
            return

        widget = self.dlg.layerslistWidget

        # Capture current selections
        current_selected = {
            widget.item(i).text().split(" (")[0]
            for i in range(widget.count())
            if widget.item(i).isSelected()
        }
        self.session_exceptions |= current_selected

        # Rebuild the list
        widget.blockSignals(True)
        widget.clear()
        current_index = -1
        for idx, layer in enumerate(QgsProject.instance().mapLayers().values()):
            layer_name = layer.name()
            type_str = (
                "Raster" if layer.type() == QgsMapLayerType.RasterLayer else "Vector"
            )
            item_text = f"{layer_name} ({type_str})"
            widget.addItem(item_text)

            # Restore session selections
            if layer_name in self.session_exceptions:
                widget.item(idx).setSelected(True)

            if layer_name == self.last_selected_layer:
                current_index = idx

        widget.blockSignals(False)
        if current_index >= 0:
            widget.setCurrentRow(current_index)

    def update_selected_exceptions(self):
        """
        Update the set of visible exception layers dynamically.

        Reads all currently selected items (MultiSelection supported) and
        updates both session memory and LayoutEditor immediately.
        """
        if not hasattr(self, "dlg") or not hasattr(self.dlg, "layerslistWidget"):
            return

        selected_exceptions = {
            item.text().split(" (")[0]
            for item in self.dlg.layerslistWidget.selectedItems()
        }

        self.session_exceptions = selected_exceptions
        self.layout_editor.set_exception_layers(self.session_exceptions)

    # -------------------------------------------------------------------------
    # Raster Layer Handling
    # -------------------------------------------------------------------------

    def get_or_load_raster_layer(self, raster_path):
        """Return existing raster layer or load it if not present in the project."""
        for layer in QgsProject.instance().mapLayers().values():
            if (
                layer.type() == QgsMapLayerType.RasterLayer
                and layer.source() == raster_path
            ):
                return layer

        raster_layer = QgsRasterLayer(raster_path, os.path.basename(raster_path))
        if raster_layer.isValid():
            QgsProject.instance().addMapLayer(raster_layer)
            return raster_layer
        return None

    # -------------------------------------------------------------------------
    # Layout Creation
    # -------------------------------------------------------------------------

    def create_layout_from_template(self):
        """
        Main flow to create a map layout from the selected template and raster.

        Applies styles, sets exception layers visibility, updates text and legend.
        """
        try:
            print("Create button clicked - starting layout generation")

            # Collect UI inputs
            template_path = self.dlg.TemplatemQgsFileWidget.filePath()
            raster_path = self.dlg.GeotiffQgsFileWidget.filePath()
            layout_name_text = self.dlg.MapLayoutTextEdit.toPlainText().strip()
            client_location_text = self.dlg.ClientLocationLayoutTextEdit.toPlainText()
            self.layout_editor.set_client_location(client_location_text)

            # Persist last focused layer for UX
            selected_item = self.dlg.layerslistWidget.currentItem()
            if selected_item:
                layer_name = selected_item.text().split(" (")[0]
                self.settings.setValue("last_selected_layer", layer_name)
                self.last_selected_layer = layer_name

            # Ensure session exceptions are up-to-date
            self.update_selected_exceptions()

            # Sanitize layout name
            layout_name = (
                re.sub(r'[\\/:*?"<>|]', "", layout_name_text)
                if layout_name_text
                else "Geophysics_Map"
            )

            # Save previous layout edits
            if self.current_layout:
                project = QgsProject.instance()
                layout_manager = project.layoutManager()
                existing = layout_manager.layoutByName(self.current_layout.name())
                if existing:
                    existing.saveAsTemplate(
                        self.active_template_path, QgsReadWriteContext()
                    )
                    print(f"Saved active layout template: {self.active_template_path}")

            # Determine template to use
            if not self.current_layout:
                use_template = self.default_template_path
            elif os.path.exists(self.active_template_path):
                use_template = self.active_template_path
            else:
                use_template = self.default_template_path

            # Create layout
            layout = self.layout_editor.create_layout(use_template, layout_name)
            if not layout:
                print("Layout could not be created.")
                return

            # Load and style raster
            if os.path.exists(raster_path):
                raster_layer = self.get_or_load_raster_layer(raster_path)
                if raster_layer:
                    qml_file = (
                        "flightpath_style.qml"
                        if "flightpath" in os.path.basename(raster_path).lower()
                        else "transparency_style.qml"
                    )
                    qml_file = os.path.join(self.plugin_dir, "templates", qml_file)

                    self.layout_editor.apply_style_qml(raster_layer, qml_file)
                    self.layout_editor.hide_other_layers(raster_layer)
                    self.layout_editor.update_map_item(
                        layout, raster_layer, zoom_to_extent=not self.current_layout
                    )

                    # Update text and legend items
                    title_text, map_desc, units_text, legend_file = (
                        self.layout_editor.get_map_info(raster_path)
                    )
                    self.layout_editor.update_text_item(layout, "Title", title_text)
                    self.layout_editor.update_text_item(
                        layout, "Client-Location", self.layout_editor.client_location
                    )
                    self.layout_editor.update_text_item(
                        layout, "Map Description", map_desc
                    )
                    self.layout_editor.update_text_item(
                        layout, "Legend Unit", units_text
                    )

                    # Handle legend path
                    legend_path = None
                    if legend_file:
                        raster_dir = os.path.dirname(raster_path)
                        candidate_path = os.path.join(
                            raster_dir, "LEGENDS", legend_file
                        )
                        if os.path.exists(candidate_path):
                            legend_path = candidate_path
                    if not legend_path or not os.path.exists(legend_path):
                        legend_path = self.dlg.LegendQgsFileWidget.filePath()

                    if os.path.exists(legend_path):
                        self.layout_editor.update_picture_item(
                            layout, "Legend (Oasis)", legend_path
                        )

            # Set current layout and open layout designer
            self.current_layout = layout
            self.iface.openLayoutDesigner(layout)
            print(f"Layout '{layout_name}' created and opened successfully")

        except Exception as e:
            print("Error creating layout:", e)
            print(traceback.format_exc())
